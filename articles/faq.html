<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Frequently Asked Questions • httptest2</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Frequently Asked Questions">
<meta property="og:description" content="httptest2">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-104182925-1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-104182925-1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">httptest2</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/httptest2.html">Get Started</a>
</li>
<li>
  <a href="../reference/">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/httptest2.html">Overview</a>
    </li>
    <li>
      <a href="../articles/redacting.html">Redacting Sensitive Information</a>
    </li>
    <li>
      <a href="../articles/vignettes.html">Using with Vignettes</a>
    </li>
    <li>
      <a href="../articles/faq.html">FAQ</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/nealrichardson/httptest2" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="https://enpiar.com" class="external-link">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Frequently Asked Questions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/nealrichardson/httptest2/blob/HEAD/vignettes/faq.Rmd" class="external-link"><code>vignettes/faq.Rmd</code></a></small>
      <div class="hidden name"><code>faq.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="where-are-my-mocks-recorded">Where are my mocks recorded?<a class="anchor" aria-label="anchor" href="#where-are-my-mocks-recorded"></a>
</h2>
<p>By default, <code><a href="../reference/with_mock_api.html">with_mock_api()</a></code> will look for and <code><a href="../reference/capture_requests.html">capture_requests()</a></code> will write mocks to your package’s <code>tests/testthat</code> directory, or else the current working directory if that path does not exist. If you want to look in or write to other places, call <code><a href="../reference/mockPaths.html">.mockPaths()</a></code> to add directories to the search path.</p>
<p>If you’re running <code><a href="../reference/capture_requests.html">capture_requests()</a></code> within a test suite in an installed package, or if you’re running interactively from a different directory, the working directory may not be the same as your code repository. If you aren’t sure where the files are going, set <code>options(httptest2.verbose = TRUE)</code>, and it will message the absolute path of the files as it writes them.</p>
<p>To change where files are being written or read from, use <code><a href="../reference/mockPaths.html">.mockPaths()</a></code> (like <code><a href="https://rdrr.io/r/base/libPaths.html" class="external-link">base::.libPaths()</a></code>) to specify a different directory.</p>
</div>
<div class="section level2">
<h2 id="how-do-i-fix-non-portable-file-paths">How do I fix “non-portable file paths”?<a class="anchor" aria-label="anchor" href="#how-do-i-fix-non-portable-file-paths"></a>
</h2>
<p>If you see this error in <code>R CMD build</code> or <code>R CMD check</code>, it means that there are file paths are longer than 100 characters, which can sometimes happen when you record requests. <code>httptest</code> preserves the URL structure of mocks in file paths to improve the readability and maintainability of your tests, as well as to make visible the properties of your API. Indeed, the file-system tree view of the mock files gives a visual representation of your API. This value comes with a tradeoff: sometimes URLs can be long, and R doesn’t like that.</p>
<p>Depending on how long your URLs are, there are a few ways to save on characters without compromising readability of your code and tests.</p>
<p>A good way to cut long file paths is by using a redactor: a function that alters the content of your requests and responses before mapping them to mock files. For example, if all of your API endpoints sit beneath <code>https://language.googleapis.com/v1/</code>, you could:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/set_redactor.html">set_redactor</a></span><span class="op">(</span><span class="kw">function</span> <span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="../reference/gsub_response.html">gsub_response</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"https\\://language.googleapis.com/v1/"</span>, <span class="st">"api/"</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>This will replace that string in all parts of the mock file that is saved, including in the file path that is written–that is, paths will start with “api/” rather than “language.googleapis.com/v1/”, saving you (in this case) 23 characters. The function will also be called when loading mocks in <code><a href="../reference/with_mock_api.html">with_mock_api()</a></code> so that the shortened file paths are found.</p>
<p>You can also provide this function in <code>inst/httptest2/redact.R</code>, and any time your package is loaded (as when you run tests or build vignettes, or when anyone else uses your package in <em>their</em> package), this function will be called automatically. See <code><a href="../articles/redacting.html">vignette("redacting")</a></code> for more.</p>
<p>You may also be able to economize on other parts of the file paths. If you’ve recorded requests and your file paths contain long ids like “1495480537a3c1bf58486b7e544ce83d”, depending on how you access the API in your code, you may be able to simply replace that id with something shorter, like “1”. The mocks are just files, disconnected from a real server and API, so you can rename them and munge them as needed.</p>
<p>Finally, if you have your tests inside a <code>tests/testthat/</code> directory, and your fixture files inside that, you can save 9 characters by moving the fixtures up to <code>tests/</code> and setting <code>.mockPaths("../")</code>.</p>
</div>
<div class="section level2">
<h2 id="how-do-i-switch-between-mocking-and-real-requests">How do I switch between mocking and real requests?<a class="anchor" aria-label="anchor" href="#how-do-i-switch-between-mocking-and-real-requests"></a>
</h2>
<p><code>httptest2</code> does not intend that every request in your test suite is something that could be run against a live server. There are practical reasons why you should be able to see, modify, and maintain test fixtures, rather than re-record them every time you make a change. Among the considerations:</p>
<ul>
<li>In many cases, API responses contain way more content than is necessary to test your R code around them: 100 records when 2 will suffice, request metadata that you don’t care about and can’t meaningfully assert things about, and so on. In the interest of minimally reproducible examples, and of making tests readable, it often makes sense to take an actual API response and delete a lot of its content, or even to fabricate one entirely.</li>
<li>It’s good to keep an API mock fixed so you know exactly what is in it. If you re-recorded a Twitter API response of, say, the most recent 10 tweets with <code>#rstats</code>, the specific content will change every time you record it, so your tests can’t say much about what is in the response without having to rewrite them every time too.</li>
<li>Some conditions (rate limiting, server errors, e.g.) are difficult to test with real responses, but if you can hand-create a API mock with, say, a 503 response status code and test how your code handles it, you can have confidence of how your package will respond when that rare event happens with the real API.</li>
<li>Re-recording all responses can make for a huge code diff, which can blow up your repository size and make code review harder.</li>
</ul>
<p>That said, it can be worthwhile to have a subset of tests that can be run against a live API so that you can detect and respond to API changes. One option is to set up some tests with the <code><a href="../reference/with_mock_dir.html">with_mock_dir()</a></code> context instead of <code><a href="../reference/with_mock_api.html">with_mock_api()</a></code>. For example:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/with_mock_dir.html">with_mock_dir</a></span><span class="op">(</span><span class="st">"httpbin-get"</span>, <span class="op">{</span>
  <span class="va">a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://httr2.r-lib.org/reference/request.html" class="external-link">request</a></span><span class="op">(</span><span class="st">"https://httpbin.org/get"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://httr2.r-lib.org/reference/req_perform.html" class="external-link">req_perform</a></span><span class="op">(</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">a</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span></code></pre></div>
<p>The first time you run the code, it will create the directory <code>tests/testthat/httpbin-get</code>, and create mock files under it. The next times you run it, it will <em>use</em> the mock files in <code>tests/testthat/httpbin-get</code>. To re-record, simply delete the directory.</p>
<p>Another option is to have a secondary integration test suite in your code repository, a directory outside of the standard R package directories and included in <code>.Rbuildignore</code> so that it doesn’t get packaged. You could run this locally with <code><a href="https://testthat.r-lib.org/reference/test_dir.html" class="external-link">testthat::test_dir()</a></code>, and you could run it on continuous integration builds by replacing the <code>tests/testthat</code> directory with the alternate test directory.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Neal Richardson.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.1.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
